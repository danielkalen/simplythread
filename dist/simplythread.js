var slice=[].slice;!function(){var PRIMITIVE_TYPES,STRINGIFY_OPTS,SUPPORTS,SimplyThread,Thread,ThreadInterface,currentID,exposeStringifyFn,functionBodyRegEx,genTransactionID,promisePolyfill,threadEmit,workerScript;return SimplyThread=new function(){var t;return t=[],this.create=function(n){var e;return e=new ThreadInterface(n),t.push(e),e},this.remove=function(n){var e;return e=t.indexOf(n),-1!==e?t.splice(e,1):void 0},this.list=function(){return t.slice()},this.killAll=function(){return t.slice().forEach(function(t){return t.kill()}),!0},this},functionBodyRegEx=/^\s*function\s*\(\)\s*\{\s*([\w\W]+)\s*\}\s*$/,SUPPORTS={workers:!!window.Worker&&!!window.Blob&&!!window.URL,promises:!!window.Promise},PRIMITIVE_TYPES={string:!0,number:!0,"boolean":!0,symbol:!0},STRINGIFY_OPTS={references:!0},currentID=0,genTransactionID=function(){return++currentID},exposeStringifyFn=function(){!function(t,n){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define(function(){return n()}):t.javascriptStringify=n()}(this,function(){function t(t){var n=u[t];return n||"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)}function n(t){return!f[t]&&l.test(t)}function e(t){return"Function("+s("return this;")+")()"}function r(t){for(var e="",r=0;r<t.length;r++)e+=n(t[r])?"."+t[r]:"["+s(t[r])+"]";return e}function o(t,n,e){var r=t.map(function(t,r){var o=e(t,r);return void 0===o?String(o):n+o.split("\n").join("\n"+n)}).join(n?",\n":",");return n&&r?"[\n"+r+"\n]":"["+r+"]"}function i(t,e,r){var o=Object.keys(t).reduce(function(o,i){var a=r(t[i],i);return void 0===a?o:(i=n(i)?i:s(i),a=String(a).split("\n").join("\n"+e),o.push(e+i+":"+(e?" ":"")+a),o)},[]).join(e?",\n":",");return e&&o?"{\n"+o+"\n}":"{"+o+"}"}function a(t){var n=String(t),e=Object.keys(t),r,o;if(o=e.length){for(r="var x="+n+";";o--;)r+="x['"+e[o]+"']="+s(t[e[o]])+";";return"(function(){"+r+"return x;}())"}return n}function s(t,n,e){if(Object(t)!==t)return d[typeof t](t,n,e);if("function"==typeof Buffer&&Buffer.isBuffer(t))return"new Buffer("+e(t.toString())+")";var r=p[Object.prototype.toString.call(t)];return r?r(t,n,e):void 0}var c=/[\\\'\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,u={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","'":"\\'",'"':'\\"',"\\":"\\\\"},f={};"break else new var case finally return void catch for switch while continue function this with default if throw delete in try do instanceof typeof abstract enum int short boolean export interface static byte extends long super char final native synchronized class float package throws const goto private transient debugger implements protected volatile double import public let yield".split(" ").map(function(t){f[t]=!0});var l=/^[A-Za-z_$][A-Za-z0-9_$]*$/,p={"[object Array]":o,"[object Object]":i,"[object Date]":function(t){return"new Date("+t.getTime()+")"},"[object String]":function(t){return"new String("+s(t.toString())+")"},"[object Number]":function(t){return"new Number("+t+")"},"[object Boolean]":function(t){return"new Boolean("+t+")"},"[object Uint8Array]":function(t,n){return"new Uint8Array("+o(t)+")"},"[object RegExp]":a,"[object Function]":a,"[object global]":e,"[object Window]":e},d={string:function(n){return"'"+n.replace(c,t)+"'"},number:String,object:String,"boolean":String,symbol:String,undefined:String};return function(t,n,e,o){function i(t,n){if(!u||void 0!==t){l.push(n);var e=g(t,s);return l.pop(),e}}o=o||{},"string"!=typeof e&&(e=new Array(Math.max(0,0|e)+1).join(" "));var a=Number(o.maxDepth)||100,c=!!o.references,u=!!o.skipUndefinedProperties,f=Number(o.maxValues)||1e5,l=[],p=[],d=[],h=[],y=[],g=c?function(t,n){if(t&&("object"==typeof t||"function"==typeof t)){var r=d.indexOf(t);if(r>-1)return void y.push(l.slice(),h[r]);d.push(t),h.push(l.slice())}if(!(l.length>a||f--<=0))return n(t,e,i)}:function(t,n){var r=p.indexOf(t);if(!(r>-1||l.length>a||f--<=0)){p.push(t);var t=n(t,e,i);return p.pop(),t}};if("function"==typeof n){var b=g;g=function(t,e){return b(t,function(t,r,o){return n(t,r,function(t){return e(t,r,o)})})}}var m=g(t,s);if(y.length){for(var v=e?"\n":"",S=e?" = ":"=",T=";"+v,b=e?"(function () {":"(function(){",I="}())",P=["var x"+S+m],w=0;w<y.length;w+=2)P.push("x"+r(y[w])+S+"x"+r(y[w+1]));return P.push("return x"),b+v+P.join(T)+T+I}return m}})},promisePolyfill='(function(){"use strict";var f,g=[];function l(a){g.push(a);1==g.length&&f()}function m(){for(;g.length;)g[0](),g.shift()}f=function(){setTimeout(m)};function n(a){this.a=p;this.b=void 0;this.f=[];var b=this;try{a(function(a){q(b,a)},function(a){r(b,a)})}catch(c){r(b,c)}}var p=2;function t(a){return new n(function(b,c){c(a)})}function u(a){return new n(function(b){b(a)})}function q(a,b){if(a.a==p){if(b==a)throw new TypeError;var c=!1;try{var d=b&&b.then;if(null!=b&&"object"==typeof b&&"function"==typeof d){d.call(b,function(b){c||q(a,b);c=!0},function(b){c||r(a,b);c=!0});return}}catch(e){c||r(a,e);return}a.a=0;a.b=b;v(a)}} function r(a,b){if(a.a==p){if(b==a)throw new TypeError;a.a=1;a.b=b;v(a)}}function v(a){l(function(){if(a.a!=p)for(;a.f.length;){var b=a.f.shift(),c=b[0],d=b[1],e=b[2],b=b[3];try{0==a.a?"function"==typeof c?e(c.call(void 0,a.b)):e(a.b):1==a.a&&("function"==typeof d?e(d.call(void 0,a.b)):b(a.b))}catch(h){b(h)}}})}n.prototype.g=function(a){return this.c(void 0,a)};n.prototype.c=function(a,b){var c=this;return new n(function(d,e){c.f.push([a,b,d,e]);v(c)})}; function w(a){return new n(function(b,c){function d(c){return function(d){h[c]=d;e+=1;e==a.length&&b(h)}}var e=0,h=[];0==a.length&&b(h);for(var k=0;k<a.length;k+=1)u(a[k]).c(d(k),c)})}function x(a){return new n(function(b,c){for(var d=0;d<a.length;d+=1)u(a[d]).c(b,c)})};self.Promise||(self.Promise=n,self.Promise.resolve=u,self.Promise.reject=t,self.Promise.race=x,self.Promise.all=w,self.Promise.prototype.then=n.prototype.c,self.Promise.prototype["catch"]=n.prototype.g);}());',ThreadInterface=function(t){var n,e;return this.fn=t,this.fnString=null!=(n=this.fn)?n.toString():void 0,this.status="active",e=new Thread(this.fn,this.fnString),Object.defineProperty(this,"thread",{enumerable:!1,configurable:!1,get:function(){return e}}),this},ThreadInterface.prototype.run=function(){var t;return t=1<=arguments.length?slice.call(arguments,0):[],"function"==typeof this.fn?this.thread.sendCommand("run",this._stringifyPayload(t)).then(function(t){return function(n){return t._parsePayload(n)}}(this))["catch"](function(t){return function(n){return Promise.reject(t._parseRejection(n))}}(this)):Promise.reject(new Error("No function was set for this thread."))},ThreadInterface.prototype.on=function(t,n){return"string"==typeof t&&"function"==typeof n?this.thread.socket.on(t,function(t){return function(e){return n(t._parsePayload(e.payload))}}(this)):void 0},ThreadInterface.prototype.setFn=function(t,n){return"function"==typeof t&&(this.fn=t,this.fnString=t.toString(),this.thread.sendCommand("setFn",this.fnString),n&&this.setContext(n)),this},ThreadInterface.prototype.setGlobals=function(t){return this.thread.sendCommand("setGlobals",this._stringifyPayload(t)),this},ThreadInterface.prototype.setScripts=function(t){return this.thread.sendCommand("setScripts",this._stringifyPayload(t)),this},ThreadInterface.prototype.setContext=function(t){return this.thread.sendCommand("setContext",this._stringifyPayload(t)),this},ThreadInterface.prototype.kill=function(){var t;return null!=(t=this.thread)&&t.worker.terminate(),this.status="dead",SimplyThread.remove(this),this},ThreadInterface.prototype._stringifyPayload=function(t){var n;return n={type:typeof t},n.data=PRIMITIVE_TYPES[n.type]?t:this.javascriptStringify(t,null,null,STRINGIFY_OPTS),n},ThreadInterface.prototype._parsePayload=function(payload){return PRIMITIVE_TYPES[payload.type]?payload.data:eval("("+payload.data+")")},ThreadInterface.prototype._parseRejection=function(t){var n,e;return n=this._parsePayload(t),n&&"object"==typeof n&&window[n.name]&&window[n.name].constructor===Function?(e=n.name&&window[n.name]?new window[n.name](n.message):new Error(n.message),e.stack=n.stack,e):n},exposeStringifyFn.call(ThreadInterface.prototype),Thread=function(t,n){return this.fn=t,this.fnString=n,this.worker=this.init(),this.socket=this.openSocket(),this.fn&&this.sendCommand("setFn",this.fnString),this},Thread.prototype.init=function(){return SUPPORTS.workers?new Worker(this.createURI()):!1},Thread.prototype.createURI=function(){var t,n,e;return e=workerScript.toString().match(functionBodyRegEx)[1],n=exposeStringifyFn.toString().match(functionBodyRegEx)[1],n+="var PRIMITIVE_TYPES = "+JSON.stringify(PRIMITIVE_TYPES)+";",n+="var STRINGIFY_OPTS = "+JSON.stringify(STRINGIFY_OPTS)+";",SUPPORTS.promises||(n+=promisePolyfill),t=new Blob([n+e],{type:"application/javascript"}),URL.createObjectURL(t)},Thread.prototype.openSocket=function(){return this.worker&&this.worker.addEventListener("message",function(t){return function(n){return n.data.ID&&t.socket.callbacks[n.data.ID]?t.socket.callbacks[n.data.ID](n.data):void 0}}(this)),{on:function(t,n){return this.callbacks[t]=n},callbacks:{}}},Thread.prototype.sendCommand=function(command,payload){return new Promise(function(_this){return function(resolve,reject){var ID;if(_this.worker)return"run"===command&&_this.socket.on(ID=genTransactionID(),function(t){switch(t.status){case"resolve":return resolve(t.payload);case"reject":return reject(t.payload)}}),_this.worker.postMessage({command:command,payload:payload,ID:ID});switch(command){case"run":if(_this.fn)return _this.fn.apply(_this.context,payload);break;case"setFn":if("function"==typeof payload)return _this.fn=eval("("+payload.toString()+")");break;case"setContext":return _this.context=payload}}}(this))},threadEmit=function(t,n){var e;return"function"==typeof(e=this.socket.callbacks)[t]?e[t](n):void 0},workerScript=function(){var _parsePayload,_stringifyError,_stringifyPayload,fnContext,fnToExecute,onmessage,run,setContext,setFn,setGlobals,setScripts;fnToExecute=null,fnContext=null,_stringifyPayload=function(t){var n;return n={type:typeof t},n.data=PRIMITIVE_TYPES[n.type]?t:javascriptStringify(t,null,null,STRINGIFY_OPTS),n},_stringifyError=function(t){var n,e,r;return e=t.name,n=t.message,r=t.stack,_stringifyPayload({name:e,message:n,stack:r})},_parsePayload=function(payload){return PRIMITIVE_TYPES[payload.type]?payload.data:eval("("+payload.data+")")},onmessage=function(t){var n,e,r;switch(e=t.data.command,r=t.data.payload,n=t.data.ID,e){case"setContext":return setContext(_parsePayload(r));case"setGlobals":return setGlobals(_parsePayload(r));case"setScripts":return setScripts(_parsePayload(r));case"setFn":return setFn(r);case"run":return run(n,_parsePayload(r))}},setGlobals=function(t){var n,e;for(n in t)e=t[n],self[n]=e},setScripts=function(t){var n,e,r;for(n=0,e=t.length;e>n;n++)r=t[n],"function"==typeof r?r.call(self):importScripts(r)},setContext=function(t){return fnContext=t},setFn=function(fnString){return eval("fnToExecute = "+fnString)},run=function(t,n){var e,r,o,i;null==n&&(n=[]);try{i=fnToExecute.apply(fnContext,n)}catch(r){e=r,postMessage({ID:t,status:"reject",payload:_stringifyError(e)}),o=!0}return o?void 0:Promise.resolve(i).then(function(n){return postMessage({ID:t,status:"resolve",payload:_stringifyPayload(n)})})["catch"](function(n){return postMessage({ID:t,status:"reject",payload:_stringifyPayload(n)})})},threadEmit=function(t,n){return postMessage({ID:t,payload:_stringifyPayload(n)})}},SimplyThread.version="1.7.0",null!=("undefined"!=typeof exports&&null!==exports?exports.module:void 0)?module.exports=SimplyThread:"function"==typeof define&&define.amd?define(["simplythread"],function(){return SimplyThread}):window.SimplyThread=SimplyThread}();