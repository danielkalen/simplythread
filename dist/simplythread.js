var slice=[].slice;
(function(){var r,t,h,k,g,n,u,f,v,w,m,x,p,l,y,z;r=!!window.Worker&&!!window.Blob&&!!window.URL;t=!!window.Promise;h=new function(){var a;a=[];this.create=function(b){b=new g(b);a.push(b);return b};this.remove=function(b){b=a.indexOf(b);if(-1!==b)return a.splice(b,1)};this.list=function(){return a.slice()};this.killAll=function(){a.slice().forEach(function(a){return a.kill()});return!0};return this};n="**_circular_**";f="**_function_**";g=function(a){var b,d;this.fn=a;this.fnString=null!=(b=this.fn)?
b.toString():void 0;this.status="active";d=new k(this.fn,this.fnString);Object.defineProperty(this,"thread",{enumerable:!1,configurable:!1,get:function(){return d}});return this};g.prototype.run=function(){var a;a=1<=arguments.length?slice.call(arguments,0):[];return new Promise(function(b){return function(d,c){return"function"===typeof b.fn?b.thread.sendCommand("run",p(a)).then(function(a){return d(m(a))},c):c(Error("No function was set for this thread."))}}(this))};g.prototype.on=function(a,b){if("string"===
typeof a&&"function"===typeof b)return this.thread.socket.on(a,b)};g.prototype.setFn=function(a,b){"function"===typeof a&&(this.fn=a,this.fnString=a.toString(),this.thread.sendCommand("setFn",this.fnString),b&&this.setContext(b));return this};g.prototype.setGlobals=function(a){this.thread.sendCommand("setGlobals",l(a));return this};g.prototype.setScripts=function(a){this.thread.sendCommand("setScripts",l(a));return this};g.prototype.setContext=function(a){var b;try{b=JSON.stringify(a)}catch(d){b=
function(){var b,d;b=[];d=JSON.stringify(a,function(d,c){if(null!==c&&"object"===typeof c)if(-1!==b.indexOf(c)){if(c===a)return n;if(null==c||!c.nodeName||!c.nodeType){if("function"===typeof c)return f+c.toString();return}}else b.push(c);return c});b=null;return d}()}this.thread.sendCommand("setContext",b);return this};g.prototype.kill=function(){var a;null!=(a=this.thread)&&a.worker.terminate();this.status="dead";h.remove(this);return this};p=function(a){var b,d,c,e,q;q=[];c=d=0;for(e=a.length;d<
e;c=++d)b=a[c],q[c]="function"===typeof b?f+b.toString():b;return q};l=function(a,b){var d,c,e;null==b&&(b=[]);if("function"===typeof a)return f+a.toString();if("object"===typeof a){b.push(a);c=Array.isArray(a)?[]:{};for(d in a)e=a[d],"object"===typeof e&&-1===b.indexOf(e)?(b.push(e),c[d]=l(e,b)):c[d]="function"===typeof e?f+e.toString():e;return c}return a};m=function(a,b){var d,c;null==b&&(b=[]);if("string"===typeof a&&0===a.indexOf(f))return eval("___ ="+a.replace(f,""));b.push(a);for(d in a)c=
a[d],"object"===typeof c&&-1===b.indexOf(c)?(b.push(c),a[d]=m(c,b)):"string"===typeof c&&0===c.indexOf(f)&&(a[d]=eval("___ ="+c.replace(f,"")));return a};k=function(a,b){this.fn=a;this.fnString=b;this.worker=this.init();this.socket=this.openSocket();this.fn&&this.sendCommand("setFn",this.fnString);return this};k.prototype.init=function(){return r?new Worker(this.createURI()):!1};k.prototype.createURI=function(){var a;a=y.toString().match(z)[1];t||(a+=x);a=new Blob([a],{type:"application/javascript"});
return URL.createObjectURL(a)};k.prototype.openSocket=function(){this.worker&&this.worker.addEventListener("message",function(a){return function(b){if(b.data.ID&&a.socket.callbacks[b.data.ID])return a.socket.callbacks[b.data.ID]("string"===typeof b.data.ID?b.data.payload:b.data)}}(this));return{on:function(a,b){return this.callbacks[a]=b},callbacks:{}}};k.prototype.sendCommand=function(a,b){return new Promise(function(d){return function(c,e){var f;if(d.worker){if("run"===a)d.socket.on(f=v(),function(a){switch(a.status){case "resolve":return c(a.payload);
case "reject":return e(w(a.payload))}});return d.worker.postMessage({command:a,payload:b,ID:f})}switch(a){case "run":if(d.fn)return d.fn.apply(d.context,b);break;case "setFn":if("function"===typeof b)return d.fn=eval("("+b.toString()+")");break;case "setContext":return d.context=b}}}(this))};u=0;v=function(){return++u};w=function(a){var b;return a&&"object"===typeof a&&window[a.name]&&window[a.name].constructor===Function?(b=a.name&&window[a.name]?new window[a.name](a.message):Error(a.message),b.stack=
a.stack,b):a};z=/^\s*function\s*\(\)\s*\{\s*([\w\W]+)\s*\}\s*$/;y=function(){n="**_circular_**";f="**_function_**";p=function(a){var b,d,c,e,g;g=[];c=d=0;for(e=a.length;d<e;c=++d)b=a[c],g[c]="function"===typeof b?f+b.toString():b;return g};l=function(a,b){var d,c,e;null==b&&(b=[]);if("function"===typeof a)return f+a.toString();if("object"===typeof a){b.push(a);c=Array.isArray(a)?[]:{};for(d in a)e=a[d],"object"===typeof e&&-1===b.indexOf(e)?(b.push(e),c[d]=l(e,b)):c[d]="function"===typeof e?f+e.toString():
e;return c}return a};m=function(a,b){var d,c;null==b&&(b=[]);if("string"===typeof a&&0===a.indexOf(f))return eval("___ ="+a.replace(f,""));b.push(a);for(d in a)c=a[d],"object"===typeof c&&-1===b.indexOf(c)?(b.push(c),a[d]=m(c,b)):"string"===typeof c&&0===c.indexOf(f)&&(a[d]=eval("___ ="+c.replace(f,"")));return a}};x='(function(){"use strict";var f,g=[];function l(a){g.push(a);1==g.length&&f()}function m(){for(;g.length;)g[0](),g.shift()}f=function(){setTimeout(m)};function n(a){this.a=p;this.b=void 0;this.f=[];var b=this;try{a(function(a){q(b,a)},function(a){r(b,a)})}catch(c){r(b,c)}}var p=2;function t(a){return new n(function(b,c){c(a)})}function u(a){return new n(function(b){b(a)})}function q(a,b){if(a.a==p){if(b==a)throw new TypeError;var c=!1;try{var d=b&&b.then;if(null!=b&&"object"==typeof b&&"function"==typeof d){d.call(b,function(b){c||q(a,b);c=!0},function(b){c||r(a,b);c=!0});return}}catch(e){c||r(a,e);return}a.a=0;a.b=b;v(a)}} function r(a,b){if(a.a==p){if(b==a)throw new TypeError;a.a=1;a.b=b;v(a)}}function v(a){l(function(){if(a.a!=p)for(;a.f.length;){var b=a.f.shift(),c=b[0],d=b[1],e=b[2],b=b[3];try{0==a.a?"function"==typeof c?e(c.call(void 0,a.b)):e(a.b):1==a.a&&("function"==typeof d?e(d.call(void 0,a.b)):b(a.b))}catch(h){b(h)}}})}n.prototype.g=function(a){return this.c(void 0,a)};n.prototype.c=function(a,b){var c=this;return new n(function(d,e){c.f.push([a,b,d,e]);v(c)})}; function w(a){return new n(function(b,c){function d(c){return function(d){h[c]=d;e+=1;e==a.length&&b(h)}}var e=0,h=[];0==a.length&&b(h);for(var k=0;k<a.length;k+=1)u(a[k]).c(d(k),c)})}function x(a){return new n(function(b,c){for(var d=0;d<a.length;d+=1)u(a[d]).c(b,c)})};self.Promise||(self.Promise=n,self.Promise.resolve=u,self.Promise.reject=t,self.Promise.race=x,self.Promise.all=w,self.Promise.prototype.then=n.prototype.c,self.Promise.prototype["catch"]=n.prototype.g);}());';
h.version="1.7.0";return null!=("undefined"!==typeof exports&&null!==exports?exports.module:void 0)?module.exports=h:"function"===typeof define&&define.amd?define(["simplythread"],function(){return h}):window.SimplyThread=h})();
